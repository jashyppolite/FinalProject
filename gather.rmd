---
title: "gather"
author: "Jasmine Hyppolite"
date: "10/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(writexl)
library(stringr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(rstanarm)
library(broom.mixed)
library(gtsummary)
library(gt)
library(huxtable)
```

## R Markdown

2019 votes in ny state leg that have to do with legistlation 
avg google search trends per year 
subset to repub and dem,m & w, 

```{r}
# CODE FOR VOTES BILLS IN NY 
votes2019 <- read.csv("data/NY/csv/bills.csv")
votes2017 <- read.csv("data/NY/bills2017-2018.csv")
votes2015 <- read.csv("data/NY/bills2015.csv")
votes2013 <- read.csv("data/NY/bills2011.csv")
votes2009 <- read.csv("data/NY/bills2009.csv")

votes <- bind_rows(votes2019, votes2017, votes2015, votes2013, votes2009)

votes_clean <- votes %>%
  mutate(Police = ifelse(str_detect(description,
                                    regex("police",
                                          ignore_case=TRUE)),1,0)) %>%
  mutate(Harrassment = ifelse(str_detect(description,
                                    regex("harassment",
                                          ignore_case=TRUE)),1,0)) %>%
  mutate(Assault = ifelse(str_detect(description,
                                     regex("sexual assault",
                                           ignore_case=TRUE)),1,0),
         month_year = format(as.Date(votes$status_date), "%Y-%m")) %>% 
  group_by(month_year) %>%
    filter(month_year != "1969-12") %>%
  summarize(police_bill_prop = mean(Police),
            hara_bill_prop = mean(Harrassment),
            assault_bill_prop = mean(Assault),
            .groups = "drop") %>%
  pivot_longer(cols = c(police_bill_prop, hara_bill_prop, assault_bill_prop),
               names_to = "bill_type",
               values_to = "bill_prop")

# saveRDS(votes_clean, file = "votesclean.RDS")


## Voting data that works with the graphs 
votes_for_trends <- votes %>%
  mutate(Police = ifelse(str_detect(description,
                                    regex("police",
                                          ignore_case=TRUE)),1,0)) %>%
  mutate(Harrassment = ifelse(str_detect(description,
                                    regex("harassment",
                                          ignore_case=TRUE)),1,0)) %>%
  mutate(Assault = ifelse(str_detect(description,
                                     regex("sexual assault",
                                           ignore_case=TRUE)),1,0),
         month_year = format(as.Date(votes$status_date), "%Y-%m")) %>% 
  group_by(month_year) %>%
  filter(month_year != "1969-12") %>%
  summarize(police_bill_prop = mean(Police),
            hara_bill_prop = mean(Harrassment),
            assault_bill_prop = mean(Assault),
            .groups = "drop") 

saveRDS(votes_clean, file = "votesfortrends.RDS")

```

```{r}
# BLACK LIVES MATTER GOOGLE TRENDS DATA
blm_google <- read.csv("data/blmtrends.csv", skip = 1) %>%
 rename(week = Week, score = X.blacklivesmatter...New.York.) %>%
  mutate(month_year = format(as.Date(week), "%Y-%m")) %>%
  group_by(month_year) %>%
  summarize(mean_score = mean(score, na.rm = TRUE),
            .groups = "drop") %>%
  mutate(ID = "blm")

## summarize and count of num of votes by month 

#saveRDS(blm_google, file = "blmgoogle.RDS")

# ME TOO GOOGLE TRENDS DATA
metoo_google <- read.csv("data/metootrends.csv", skip = 1) %>%
   rename(week = Week, score = X.metoo...New.York.) %>%
  mutate(month_year = format(as.Date(week), "%Y-%m")) %>%
  group_by(month_year) %>%
  summarize(mean_score = mean(score, na.rm = TRUE),
            .groups = "drop") %>%
    mutate(ID = "metoo")



#COMBINES VOTES AND BLM
blm_votes <- left_join(blm_google, votes_for_trends, by = "month_year") %>%
  select(-hara_bill_prop, -assault_bill_prop) %>%
  mutate(police_bill_prop = ifelse(is.na(police_bill_prop), 0,
                                   police_bill_prop),
         mean_score_scale = scale(mean_score),
         police_bill_prop_scale = scale(police_bill_prop)) %>%
  #mutate(month_year = format(as.Date(month_year), "%Y-%m")) %>%
  mutate(month_year = as.numeric(month_year))


#saveRDS(blm_votes, file = "blmvotes.RDS")

#COMBINES VOTES AND METOO
metoo_votes <- left_join(metoo_google, votes_for_trends, by = "month_year") %>%
  #mutate(month_year = format(as.Date(month_year), "%Y-%m")) %>%
  #mutate(month_year = as.numeric(month_year)) %>%
  select(-police_bill_prop) %>%
  mutate(hara_bill_prop = ifelse(is.na(hara_bill_prop), 0, hara_bill_prop),
         assault_bill_prop = ifelse(is.na(assault_bill_prop), 0,
                                    assault_bill_prop),
         mean_score_scale = scale(mean_score),
         hara_bill_prop_scale = scale(hara_bill_prop),
         assault_bill_prop_scale = scale(assault_bill_prop))
#saveRDS(metoo_votes, file = "metoovotes.RDS")


trends <- bind_rows(blm_google, metoo_google) 

#saveRDS(trends, file = "trends.RDS")


trends_w_vote <- left_join(trends, votes_for_trends, by = "month_year") %>%
  pivot_longer(cols = c(police_bill_prop, hara_bill_prop, assault_bill_prop),
               names_to = "bill_type",
               values_to = "bill_prop")

#saveRDS(trends_w_vote, file = "trendswvoteclean.RDS")

      trends_w_vote %>%
        filter(bill_type == "assault_bill_prop") %>%
      ggplot(aes(x = mean_score, y = bill_prop)) + geom_point() + 
      geom_smooth(method = "lm", formula = y ~ x) + 
      labs(title = "Correlation Between Bills in NY Regarding Bill Type and Google Trend Scores",
           x = "Mean Google Trend Score for Movement",
           y = "Proportion of Bills per Week")



```


```{r graphs}
# BLM GRAPHS

blm_votes %>%
  ggplot(aes(x = mean_score, y = police_bill_prop)) + geom_point() + 
  geom_smooth(method = "lm", formula = y ~ x) + 
  labs(title = "Correlation Between Bills in NY Regarding Policing and Google Trend Scores",
        x = "Mean Google Trend Score for #BlackLivesMatter",
        y = "Proportion of Bills regarding Policing per Week")
```

```{r}
#METOO GRAPHS

  ## Harassment
 metoo_votes %>%
   ggplot(aes(x = mean_score, y = hara_bill_prop)) + geom_point() + 
   geom_smooth(method = "lm", formula = y ~ x) + 
   labs(title = "Correlation Between Bills in NY Regarding Harassment and Google Trend Scores",
        x = "Mean Google Trend Score for #MeToo",
        y = "Proportion of Bills regarding Harassment per Week") +
  theme_bw()
  ## Assault
 metoo_votes %>%
  ggplot(aes(x = mean_score, y = assault_bill_prop)) + geom_point() + 
  geom_smooth(method = "lm", formula = y ~ x) + 
  labs(title = "Correlation Between Bills in NY Regarding Assault and Google Trend Scores",
        x = "Mean Google Trend Score for #MeToo",
        y = "Proportion of Bills regarding Assault per Week")
 
```

```{r}
# VOTES GRAPHS SEPARATELY 
 # policing 
votes_clean %>%
  filter(bill_type == "police_bill_prop") %>%
  ggplot(aes(x = month_year, y = bill_prop)) + 
  geom_point(color = "orange") +
  theme(axis.text.x = element_text(angle = - 90, vjust = 0.5)) +
  labs(title = "Proportion of Police Related Bills per Month in NY",
       x = "Month and Year",
       y = "Police Bill Proportion")
   

# harassment
votes_clean %>%
  filter(bill_type == "hara_bill_prop") %>%
ggplot(aes(x = month_year, y = bill_prop)) + 
  geom_point(color = "purple") +
  theme(axis.text.x = element_text(angle = - 90, vjust = 0.5)) + 
  labs(title = "Proportion of Harassment Related Bills per Month in NY",
       x = "Month and Year",
       y = "Harassment Bill Proportion") 

## assault

votes_clean %>%
  filter(bill_type == "assault_bill_prop") %>%
ggplot(aes(x = month_year, y = bill_prop)) + 
  geom_point(color = "salmon") +
  theme(axis.text.x = element_text(angle = - 90, vjust = 0.5)) + 
  labs(title = "Proportion of Assault Related Bills per Month in NY",
       x = "Month and Year",
       y = "Assault Bill Proportion") 

## rescale one var to fit with the other 

## Google trends data
blm_google %>%
  ggplot(aes(x = month_year, y = mean_score)) + 
  geom_point(color = "red") + 
  geom_line(color = "gray") + 
  theme(axis.text.x = element_text(angle = - 90, vjust = 0.5)) + 
  labs(title = "Google Trends for Frequency of #BlackLivesMatter Searches by Month",
       x = "Month and Year",
       y = "Google Score") 

metoo_google %>%
  ggplot(aes(x = month_year, y = mean_score)) + 
  geom_point(color = "purple") + 
  geom_line(color = "gray") + 
  theme(axis.text.x = element_text(angle = - 90, vjust = 0.5)) + 
  labs(title = "Google Trends for Frequency of #MeToo Searches by Month",
       x = "Month and Year",
       y = "Google Score") 



votes_clean %>%
  filter(bill_type == "hara_bill_prop") %>%
  ggplot(aes(x = month_year, y = bill_prop)) + 
  geom_point(color = "deepskyblue3") + 
  theme(axis.text.x = element_text(angle = - 90, vjust = 0.5)) 
## plot on x axis: google search trends

```
STATISTICAL ANALYSIS

```{r}

assault_pred <- stan_glm(assault_bill_prop ~ mean_score,
         data = metoo_votes,
         family = gaussian(),
         refresh = 0)

print(assault_pred, digits = 4)

#saveRDS(assault_pred, file = "assaultpred.RDS")


police_pred <- stan_glm(police_bill_prop ~ mean_score,
                        data = blm_votes,
                        family = gaussian(),
                        refresh = 0)
print(police_pred, digits = 6)

#saveRDS(police_pred, file = "policepred.RDS")


lm(police_bill_prop ~ mean_score,
   data = blm_votes)

hara_pred <- stan_glm(hara_bill_prop ~ mean_score,
                      data = metoo_votes,
                      family = gaussian(),
                      refresh = 0)

print(hara_pred, digits = 10)

# 
#saveRDS(hara_pred, file = "harapred.RDS")


blm_votes %>% 
  ggplot(aes(x = mean_score, y = police_bill_prop)) +
  geom_point() +
  geom_line(aes(y = fitted(police_pred)), color = "blue") + 
  geom_smooth(method = "lm") + 
  geom_label(
    label = "Slope: .0006", 
    x= 30,
    y= .055,
    color = "black") + 
  labs(title = "Correlation between Google Trends Score Regarding #BlackLivesMatter
          and Legislation Regarding Policing",
       subtitle = "Description", 
       caption = "Source",
       x = "Average Google Trends Score per Month",
       y = "Police Bill Prop by Month") +
  scale_x_continuous(labels = scales::label_number()) +
  scale_y_continuous(labels = scales::label_number()) +
  theme_bw()

metoo_votes %>% 
  ggplot(aes(x = mean_score, y = assault_bill_prop)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    geom_line(aes(y = fitted(assault_pred)), color = "blue") +
    geom_label(
    label = "Slope: .0002", 
    x= 20,
    y= .006,
    color = "black") + 
    labs(title = "Correlation between Google Trends Score Regarding #MeToo
          and Legislation Regarding Assault",
         subtitle = "Description", 
         caption = "Source",
         x = "Average Google Trends Score per Month",
         y = "Assault Bill Proportion by Month") +
    scale_x_continuous(labels = scales::label_number()) +
    scale_y_continuous(labels = scales::label_number()) +
    theme_bw()

metoo_votes %>% 
  ggplot(aes(x = mean_score, y = hara_bill_prop)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    geom_line(aes(y = fitted(hara_pred)), color = "blue") +
    geom_label(
    label = "Slope: .0006", 
    x= 22.5,
    y= .02,
    color = "black") + 
    labs(title = "Correlation between Google Trends Score Regarding #MeToo
          and Legislation Regarding Harassment",
         subtitle = "Description", 
         x = "Average Google Trends Score per Month",
         y = "Harassment Bill Proportion by Month") +
    scale_x_continuous(labels = scales::label_number()) +
    scale_y_continuous(labels = scales::label_number()) +
    theme_bw()
# for every 1 point increase in google trend score, there is a .006 increase in the proportion of bills discissed
```


TABLE

```{r}


table <- huxreg("Police Model"  = police_pred,
       "Harassment Model" = hara_pred,
       "Assault Model" = assault_pred,
       coefs = c("Intercept" = "(Intercept)", "Mean Google Trend Change" = "mean_score"),
       number_format = 5,
       statistics = c("Number of Observations" = "nobs"))


saveRDS(table, file = "table.RDS")


#       error_format = "{conf.low} to {conf.high}")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
